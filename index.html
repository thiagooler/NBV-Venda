<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>NBV Admin - Master V14</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="database.js"></script>
    <style>
        :root { --primary: #0066cc; --bg: #f3f4f6; --sidebar: #fff; --text: #1f2937; --border: #e5e7eb; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 280px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .nav-btn { width: 100%; text-align: left; padding: 12px; margin-bottom: 5px; cursor: pointer; border: none; background: none; color: #666; font-weight: 600; display: flex; align-items: center; gap: 10px; border-radius: 6px; }
        .nav-btn:hover, .nav-btn.active { background: #eff6ff; color: var(--primary); }
        .nav-btn.active { font-weight: 700; border-right: 3px solid var(--primary); }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.85rem; color:#555; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 0.9rem; }
        
        /* TABLES */
        .list-item, .table-row { background: #fff; padding: 10px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 5px; display:flex; align-items:center; gap:10px; }
        
        /* BUTTONS */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; transition:0.2s }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: #10b981; }
        .btn-dark { background: #1f2937; }
        .btn-remove { background: #fee2e2; color: #dc2626; border: none; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; font-weight:bold; }
        .btn-add { background: #ecfdf5; color: #10b981; border: 1px dashed #10b981; }

        .status-bar { padding:15px; border-radius:8px; margin-bottom:20px; font-weight:bold; display:none; }
        .status-success { background:#dcfce7; color:#166534; }
        .status-error { background:#fee2e2; color:#991b1b; }
        .status-loading { background:#e0f2fe; color:#075985; }
        
        .gh-config { background: #f1f5f9; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 20px; font-size: 0.85rem; }
        .gh-config input { padding: 6px; margin-bottom: 5px; border:1px solid #cbd5e1 }
        .row { display: flex; gap: 15px; } .col { flex: 1; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2 style="margin:0 0 20px; color:#333"><i class="fas fa-camera"></i> Studio<span style="color:var(--primary)">NBV</span></h2>
        
        <div class="gh-config">
            <label><i class="fab fa-github"></i> GitHub</label>
            <input type="password" id="ghToken" placeholder="Token">
            <input type="text" id="ghUser" placeholder="Usu√°rio">
            <input type="text" id="ghRepo" placeholder="Reposit√≥rio">
            <input type="text" id="ghBranch" placeholder="Branch (main)" value="main">
            <button class="btn btn-dark" style="padding:5px; font-size:0.8rem" onclick="salvarCredenciaisLocal()">Salvar</button>
        </div>

        <nav>
            <button class="nav-btn active" onclick="showTab('tab-cliente')"><i class="fas fa-user-plus"></i> Novo Cliente</button>
            <button class="nav-btn" onclick="showTab('tab-fotolivros')"><i class="fas fa-book"></i> Tabela Fotolivros</button>
            <button class="nav-btn" onclick="showTab('tab-produtos')"><i class="fas fa-images"></i> Produtos Avulsos</button>
            <button class="nav-btn" onclick="showTab('tab-textos')"><i class="fas fa-paragraph"></i> Apresenta√ß√£o</button>
            <button class="nav-btn" onclick="showTab('tab-config')"><i class="fas fa-cogs"></i> Configs Gerais</button>
        </nav>

        <div style="margin-top:auto">
            <button class="btn btn-primary" onclick="salvarDatabaseGlobal()"><i class="fas fa-cloud-upload-alt"></i> SALVAR DB GLOBAL</button>
            <small style="display:block; text-align:center; color:#666; font-size:0.7rem; margin-top:5px">Salva produtos/pre√ßos no GitHub</small>
        </div>
    </div>

    <div class="main-content">
        <div id="status-display" class="status-bar"></div>

        <div id="tab-cliente" class="section active">
            <h2>Gerar Link do Cliente</h2>
            <div style="background:white; padding:20px; border-radius:8px; border:1px solid #eee">
                <label>Nome do Cliente (Pasta)</label>
                <input type="text" id="cliNome" placeholder="Ex: Casamento_Ana">
                <label>Links das Fotos</label>
                <textarea id="cliFotos" rows="6"></textarea>
                <button class="btn btn-success" onclick="publicarCliente()">GERAR E PUBLICAR SITE</button>
            </div>
        </div>

        <div id="tab-fotolivros" class="section">
            <h2>Tabela Fotolivros</h2>
            <div style="background:white; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #eee">
                <div class="row">
                    <div class="col"><label>Markup</label><input type="number" id="confMarkup" step="0.1"></div>
                    <div class="col"><label>Custo Fixo</label><input type="number" id="confCustoFixo"></div>
                    <div class="col"><label>M√≠nimo Fotos</label><input type="number" id="confMinFotos"></div>
                </div>
            </div>
            <div id="fotolivro-table"></div>
            <button class="btn btn-add" onclick="addBookRow()">+ Nova Linha</button>
            
            <h4 style="margin-top:20px">Regras (Fotos/P√°g)</h4>
            <div id="regras-container" style="display:flex; gap:10px; flex-wrap:wrap"></div>
        </div>

        <div id="tab-produtos" class="section">
            <h2>Produtos Avulsos</h2>
            <div id="produtos-list"></div>
            <button class="btn btn-add" onclick="addProdRow()">+ Novo Produto</button>
        </div>

        <div id="tab-textos" class="section">
            <h2>Apresenta√ß√£o (Modais e Cards)</h2>
            <div style="background:white; padding:20px; border-radius:8px; border:1px solid #eee">
                <h3 style="color:var(--primary)">üìö Fotolivro</h3>
                <input type="text" id="txtBookTitle" placeholder="T√≠tulo">
                <textarea id="txtBookDesc" rows="2" placeholder="Descri√ß√£o"></textarea>
                <label>URL da Imagem</label><input type="text" id="imgBook">

                <h3 style="color:var(--primary); margin-top:20px">üñºÔ∏è Revela√ß√£o</h3>
                <input type="text" id="txtPrintTitle" placeholder="T√≠tulo">
                <textarea id="txtPrintDesc" rows="2" placeholder="Descri√ß√£o"></textarea>
                <label>URL da Imagem</label><input type="text" id="imgPrint">

                <h3 style="color:var(--primary); margin-top:20px">üíæ Arquivo Digital</h3>
                <input type="text" id="txtDigTitle" placeholder="T√≠tulo">
                <textarea id="txtDigDesc" rows="2" placeholder="Descri√ß√£o"></textarea>
                <label>URL da Imagem</label><input type="text" id="imgDig">
            </div>
        </div>

        <div id="tab-config" class="section">
            <h2>Configura√ß√µes Gerais</h2>
            <div style="background:white; padding:20px; border-radius:8px; border:1px solid #eee">
                <div class="row">
                    <div class="col"><label>Marca D'√°gua Texto</label><input type="text" id="confWmText"></div>
                    <div class="col"><label>Opacidade</label><input type="number" id="confWmOp" step="0.1"></div>
                </div>
                <div class="row">
                    <div class="col"><label>WhatsApp</label><input type="text" id="confWhats"></div>
                    <div class="col"><label>Desconto Pix (%)</label><input type="number" id="confPix"></div>
                </div>
                <label>Frete Fixo (Transportadora)</label><input type="number" id="confFreteValor">
                <label>Cidades Gr√°tis (Separe por v√≠rgula)</label><input type="text" id="confFreteCidades">
                <label>Endere√ßo Sede</label><input type="text" id="confSede">
                <label>Tabela Juros (Separe por v√≠rgula)</label><input type="text" id="confJuros">
            </div>
        </div>
    </div>

<script>
    window.onload = function() {
        carregarCredenciaisLocal();
        if(window.NBV_DB) carregarDadosNaTela(window.NBV_DB);
        else showStatus("Erro: database.js n√£o carregado.", "error");
    };

    function showTab(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    function showStatus(msg, type='loading') {
        const el = document.getElementById('status-display');
        el.className = 'status-bar status-' + type;
        el.innerHTML = msg;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 8000);
    }

    // --- CARREGAMENTO DE DADOS (DB -> TELA) ---
    function carregarDadosNaTela(db) {
        // Financeiro & Configs
        document.getElementById('confMarkup').value = db.financeiro.markup;
        document.getElementById('confCustoFixo').value = db.financeiro.custoFixoDiagramacao;
        document.getElementById('confMinFotos').value = db.fluxo.minimoFotosLivro;
        document.getElementById('confWhats').value = db.financeiro.whatsapp;
        document.getElementById('confPix').value = db.financeiro.descontoPix;
        document.getElementById('confJuros').value = db.financeiro.tabelaJuros.join(', ');
        
        document.getElementById('confFreteValor').value = db.logistica.taxaEnvio;
        document.getElementById('confFreteCidades').value = db.logistica.cidadesGratis.join(', ');
        document.getElementById('confSede').value = db.logistica.enderecoSede;

        document.getElementById('confWmText').value = db.assets.watermarkText;
        document.getElementById('confWmOp').value = db.assets.opacity;

        // Textos Apresenta√ß√£o
        const apr = db.apresentacao || {};
        if(apr.fotolivro) { 
            document.getElementById('txtBookTitle').value = apr.fotolivro.titulo; 
            document.getElementById('txtBookDesc').value = apr.fotolivro.texto; 
            document.getElementById('imgBook').value = apr.fotolivro.img; 
        }
        if(apr.revelacao) { 
            document.getElementById('txtPrintTitle').value = apr.revelacao.titulo; 
            document.getElementById('txtPrintDesc').value = apr.revelacao.texto; 
            document.getElementById('imgPrint').value = apr.revelacao.img; 
        }
        if(apr.digital) { 
            document.getElementById('txtDigTitle').value = apr.digital.titulo; 
            document.getElementById('txtDigDesc').value = apr.digital.texto; 
            document.getElementById('imgDig').value = apr.digital.img; 
        }

        // Tabelas (AQUI ESTAVA O ERRO ANTERIOR, AGORA EST√Å PRESENTE)
        renderBooks(db.tabelaFotolivros);
        renderProds(db.produtosAvulsos);
        renderRegras(db.regrasDiagramacao);
    }

    function renderBooks(list) {
        const el = document.getElementById('fotolivro-table');
        el.innerHTML = '';
        list.forEach(item => addBookRow(item));
    }
    function addBookRow(item = {}) {
        const html = `
        <div class="table-row book-row">
            <select class="bk-size" style="width:100px"><option ${item.size=='15x20'?'selected':''}>15x20</option><option ${item.size=='20x30'?'selected':''}>20x30</option><option ${item.size=='30x40'?'selected':''}>30x40</option></select>
            <input type="number" class="bk-pages" value="${item.pages||''}" placeholder="P√°gs" style="width:80px">
            <input type="number" class="bk-price" value="${item.price||''}" placeholder="Base">
            <input type="number" class="bk-box" value="${item.priceBox||''}" placeholder="C/ Caixa">
            <button class="btn-remove" onclick="this.parentElement.remove()">X</button>
        </div>`;
        document.getElementById('fotolivro-table').insertAdjacentHTML('beforeend', html);
    }

    function renderProds(list) {
        const el = document.getElementById('produtos-list');
        el.innerHTML = '';
        list.forEach(item => addProdRow(item));
    }
    function addProdRow(item = {}) {
        const html = `
        <div class="list-item prod-row">
            <input type="text" class="pd-name" value="${item.nome||''}" placeholder="Nome" style="flex:2">
            <input type="number" class="pd-price" value="${item.preco||''}" placeholder="Pre√ßo" style="flex:1">
            <input type="text" class="pd-icon" value="${item.icone||'fas fa-image'}" placeholder="Icone" style="flex:1">
            <button class="btn-remove" onclick="this.parentElement.remove()">X</button>
        </div>`;
        document.getElementById('produtos-list').insertAdjacentHTML('beforeend', html);
    }

    function renderRegras(regras) {
        const el = document.getElementById('regras-container');
        el.innerHTML = '';
        for(let key in regras) {
            el.innerHTML += `<div><label>${key}</label><input type="number" class="regra-item" data-key="${key}" value="${regras[key]}" style="width:60px"></div>`;
        }
    }

    // --- MONTAGEM DO OBJETO ---
    function montarObjetoDB() {
        const livros = [];
        document.querySelectorAll('.book-row').forEach(r => {
            livros.push({
                size: r.querySelector('.bk-size').value,
                pages: parseInt(r.querySelector('.bk-pages').value),
                price: parseFloat(r.querySelector('.bk-price').value),
                priceBox: parseFloat(r.querySelector('.bk-box').value)
            });
        });

        const produtos = [];
        document.querySelectorAll('.prod-row').forEach(r => {
            produtos.push({
                nome: r.querySelector('.pd-name').value,
                preco: parseFloat(r.querySelector('.pd-price').value),
                icone: r.querySelector('.pd-icon').value
            });
        });

        const regras = {};
        document.querySelectorAll('.regra-item').forEach(r => {
            regras[r.dataset.key] = parseInt(r.value);
        });

        return {
            assets: {
                watermarkText: document.getElementById('confWmText').value,
                opacity: parseFloat(document.getElementById('confWmOp').value)
            },
            fluxo: {
                pedirEdicao: true,
                pedirAprovacao: true,
                minimoFotosLivro: parseInt(document.getElementById('confMinFotos').value)
            },
            logistica: {
                taxaEnvio: parseFloat(document.getElementById('confFreteValor').value),
                cidadesGratis: document.getElementById('confFreteCidades').value.split(',').map(s=>s.trim()),
                enderecoSede: document.getElementById('confSede').value
            },
            financeiro: {
                descontoPix: parseFloat(document.getElementById('confPix').value),
                parcelasSemJuros: 4,
                tabelaJuros: document.getElementById('confJuros').value.split(',').map(Number),
                whatsapp: document.getElementById('confWhats').value,
                markup: parseFloat(document.getElementById('confMarkup').value),
                custoFixoDiagramacao: parseFloat(document.getElementById('confCustoFixo').value)
            },
            apresentacao: {
                fotolivro: { titulo: document.getElementById('txtBookTitle').value, texto: document.getElementById('txtBookDesc').value, img: document.getElementById('imgBook').value },
                revelacao: { titulo: document.getElementById('txtPrintTitle').value, texto: document.getElementById('txtPrintDesc').value, img: document.getElementById('imgPrint').value },
                digital: { titulo: document.getElementById('txtDigTitle').value, texto: document.getElementById('txtDigDesc').value, img: document.getElementById('imgDig').value }
            },
            produtosAvulsos: produtos,
            tabelaFotolivros: livros,
            regrasDiagramacao: regras
        };
    }

    // --- GITHUB ---
    function getGh() {
        return {
            token: document.getElementById('ghToken').value,
            user: document.getElementById('ghUser').value,
            repo: document.getElementById('ghRepo').value,
            branch: document.getElementById('ghBranch').value
        };
    }
    function salvarCredenciaisLocal() {
        const c = getGh();
        localStorage.setItem('nbv_gh_token', c.token); localStorage.setItem('nbv_gh_user', c.user);
        localStorage.setItem('nbv_gh_repo', c.repo); localStorage.setItem('nbv_gh_branch', c.branch);
        alert("Salvo!");
    }
    function carregarCredenciaisLocal() {
        if(localStorage.getItem('nbv_gh_token')) document.getElementById('ghToken').value = localStorage.getItem('nbv_gh_token');
        if(localStorage.getItem('nbv_gh_user')) document.getElementById('ghUser').value = localStorage.getItem('nbv_gh_user');
        if(localStorage.getItem('nbv_gh_repo')) document.getElementById('ghRepo').value = localStorage.getItem('nbv_gh_repo');
        if(localStorage.getItem('nbv_gh_branch')) document.getElementById('ghBranch').value = localStorage.getItem('nbv_gh_branch');
    }

    async function upload(creds, path, content, msg) {
        const url = `https://api.github.com/repos/${creds.user}/${creds.repo}/contents/${path}`;
        let sha = null;
        try { const r = await fetch(url+`?ref=${creds.branch}`,{headers:{Authorization:`token ${creds.token}`}}); if(r.ok) sha = (await r.json()).sha; } catch(e){}
        
        const res = await fetch(url, {
            method: 'PUT',
            headers: { Authorization:`token ${creds.token}`, 'Content-Type':'application/json' },
            body: JSON.stringify({ message: msg, content: btoa(unescape(encodeURIComponent(content))), branch: creds.branch, sha: sha })
        });
        if(!res.ok) throw new Error((await res.json()).message);
        return `https://${creds.user}.github.io/${creds.repo}/${path}`;
    }

    async function salvarDatabaseGlobal() {
        const creds = getGh();
        if(!creds.token) return alert("Configure GitHub");
        showStatus("Salvando...", "loading");
        try {
            const db = montarObjetoDB();
            await upload(creds, 'database.js', `window.NBV_DB = ${JSON.stringify(db, null, 4)};`, "Update DB");
            window.NBV_DB = db;
            showStatus("Salvo com sucesso!", "success");
        } catch(e) { showStatus("Erro: "+e.message, "error"); }
    }

    async function publicarCliente() {
        const creds = getGh();
        const nome = document.getElementById('cliNome').value.trim();
        if(!creds.token || !nome) return alert("Preencha dados");
        showStatus("Gerando...", "loading");
        
        try {
            const db = montarObjetoDB();
            const config = { ...db, cliente: { nome: nome }, fotos: document.getElementById('cliFotos').value.split('\n').filter(s=>s.length>5) };
            
            const req = await fetch('modelo.html');
            let html = await req.text();
            html = html.replace('', `<script>window.NBV_CONFIG = ${JSON.stringify(config, null, 2)};<\/script>`);
            
            const url = await upload(creds, `clientes/${nome}/index.html`, html, `Site: ${nome}`);
            showStatus(`Sucesso! <a href="${url}" target="_blank">${url}</a>`, "success");
        } catch(e) { showStatus("Erro: "+e.message, "error"); }
    }
</script>
</body>
</html>
