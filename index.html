<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>NBV Admin - V16 (Blindado)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root { --primary: #0066cc; --bg: #f3f4f6; --sidebar: #fff; --text: #1f2937; --border: #e5e7eb; --success: #16a34a; --danger: #dc2626; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 280px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        
        .status-bar { padding: 10px; border-radius: 6px; margin-bottom: 20px; text-align: center; font-size: 0.85rem; font-weight: 600; transition: 0.3s; }
        .status-disconnected { background: #fee2e2; color: var(--danger); border: 1px solid #fca5a5; }
        .status-connected { background: #dcfce7; color: var(--success); border: 1px solid #86efac; }

        .nav-btn { width: 100%; text-align: left; padding: 12px; margin-bottom: 5px; cursor: pointer; border: none; background: none; color: #666; font-weight: 600; display: flex; align-items: center; gap: 10px; border-radius: 6px; }
        .nav-btn:hover, .nav-btn.active { background: #eff6ff; color: var(--primary); }
        .section { display: none; } .section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }
        
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; margin-top: 5px; }
        label { font-weight: 600; font-size: 0.9rem; color: #374151; }
        .form-group { margin-bottom: 15px; }
        .row { display: flex; gap: 15px; } .col { flex: 1; }

        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary); } 
        .btn-github { background: #24292e; }
        .btn-add { background: #ecfdf5; color: #16a34a; border: 1px dashed #16a34a; }
        .btn-remove { background: #fee2e2; color: #dc2626; border: none; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; }

        .list-item { background: #fff; padding: 10px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 5px; display:flex; align-items:center; gap:10px; }
        .credito-box { border: 1px dashed var(--primary); padding: 15px; border-radius: 8px; background: #f0f9ff; margin-top: 15px; }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 1000; display: none; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <i class="fas fa-spinner fa-spin" style="font-size: 40px; color: var(--primary)"></i>
        <p id="loading-text" style="margin-top: 15px; font-weight: 600; color: #555">Conectando...</p>
    </div>

    <div class="sidebar">
        <h2 style="margin:0 0 20px; font-size:1.4rem; color:#333"><i class="fas fa-camera"></i> Studio<span style="color:var(--primary)">NBV</span></h2>
        
        <div id="status-display" class="status-bar status-disconnected">
            <i class="fas fa-plug"></i> Off-line
        </div>

        <nav>
            <button class="nav-btn active" onclick="showTab('tab-github')"><i class="fab fa-github"></i> Conex√£o</button>
            <button class="nav-btn" onclick="showTab('tab-financeiro')"><i class="fas fa-coins"></i> Configura√ß√µes</button>
            <button class="nav-btn" onclick="showTab('tab-apresentacao')"><i class="fas fa-bullhorn"></i> Textos</button>
            <button class="nav-btn" onclick="showTab('tab-fotolivro')"><i class="fas fa-book"></i> Fotolivros</button>
            <button class="nav-btn" onclick="showTab('tab-produtos')"><i class="fas fa-images"></i> Avulsos</button>
            <div style="height:1px; background:#eee; margin:10px 0"></div>
            <button class="nav-btn" onclick="showTab('tab-cliente')"><i class="fas fa-user"></i> Novo Pedido</button>
        </nav>
        
        <div style="margin-top:auto; padding-top:15px; border-top:1px solid #eee">
            <button class="btn btn-primary" onclick="gerarSiteCompleto()" id="btn-gerar" disabled style="opacity:0.5; cursor:not-allowed">
                <i class="fas fa-file-zipper"></i> GERAR SITE
            </button>
        </div>
    </div>

    <div class="main-content">

        <div id="tab-github" class="section active">
            <h2>‚òÅÔ∏è Conex√£o GitHub</h2>
            <div class="card" style="background:white; padding:20px; border-radius:8px; border:1px solid #ddd">
                <div class="form-group">
                    <label>Token Pessoal (GitHub)</label>
                    <input type="password" id="ghToken">
                </div>
                <div class="row">
                    <div class="col"><label>Usu√°rio</label><input type="text" id="ghUser"></div>
                    <div class="col"><label>Reposit√≥rio</label><input type="text" id="ghRepo"></div>
                </div>
                <div class="form-group" style="margin-top:15px">
                    <label>Caminho do Arquivo (Ex: js/database.js)</label>
                    <input type="text" id="ghPath" value="js/database.js">
                </div>
                <div class="row" style="margin-top:20px">
                    <div class="col">
                        <button class="btn btn-primary" onclick="Github.carregar(true)">
                            <i class="fas fa-sync"></i> Conectar e Baixar
                        </button>
                    </div>
                    <div class="col">
                        <button class="btn btn-github" onclick="Github.salvar()">
                            <i class="fas fa-cloud-upload-alt"></i> Salvar Altera√ß√µes
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-cliente" class="section">
            <h2>Dados do Cliente</h2>
            <div class="form-group"><label>Nome</label><input type="text" id="cliName"></div>
            <div class="form-group"><label>Links Fotos (Uma URL por linha)</label><textarea id="cliFotos" rows="6"></textarea></div>
            
            <div class="mode-selector">
                <label>Objetivo:</label>
                <select id="fluxoModo">
                    <option value="venda">üí∞ Venda Completa</option>
                    <option value="aprovacao">‚úÖ Apenas Aprova√ß√£o</option>
                </select>
            </div>

            <div class="row">
                <div class="col"><label>Entrada Paga (R$)</label><input type="number" id="cliEntrada" value="0.00"></div>
                <div class="col">
                    <label>J√° tem √°lbum pago?</label>
                    <select id="cliIncluirAlbum"><option value="nao">N√£o</option><option value="sim">Sim</option></select>
                </div>
            </div>

            <div class="credito-box">
                <label style="color:var(--primary)">üéÅ Cr√©ditos / Brindes</label>
                <div id="creditos-list"></div>
                <button class="btn btn-add" style="width:auto; padding:8px" onclick="addCreditoRow()">+ Item</button>
            </div>
        </div>

        <div id="tab-financeiro" class="section">
            <h2>Configura√ß√µes Gerais</h2>
            <div class="row">
                <div class="col"><label>Markup</label><input type="number" id="markup"></div>
                <div class="col"><label>Custo Fixo</label><input type="number" id="custoFixo"></div>
            </div>
            <div class="form-group"><label>WhatsApp</label><input type="text" id="whatsNum"></div>
            <div class="form-group"><label>Taxa Entrega</label><input type="number" id="shipPrice"></div>
            <div class="form-group"><label>Endere√ßo Sede</label><input type="text" id="endSede"></div>
            <div class="form-group"><label>Cidades Gr√°tis</label><input type="text" id="freeCities"></div>
            <div class="form-group"><label>Marca D'√°gua</label><input type="text" id="wmText"></div>
        </div>

        <div id="tab-apresentacao" class="section">
            <h2>Textos</h2>
            <label>Fotolivro</label><textarea id="txtBook" rows="2"></textarea>
            <input type="text" id="imgBook" placeholder="URL Imagem">
            <hr>
            <label>Revela√ß√£o</label><textarea id="txtPrint" rows="2"></textarea>
            <input type="text" id="imgPrint" placeholder="URL Imagem">
        </div>

        <div id="tab-fotolivro" class="section">
            <h2>Tabela Fotolivro</h2>
            <div id="fotolivro-table"></div>
            <button class="btn btn-add" onclick="addBookRow()">+ Tamanho</button>
        </div>

        <div id="tab-produtos" class="section">
            <h2>Produtos Avulsos</h2>
            <div id="produtos-list"></div>
            <button class="btn btn-add" onclick="addProdRow()">+ Produto</button>
        </div>

    </div>

    <script src="js/database.js" onerror="console.log('Database local n√£o encontrado. Conecte ao GitHub.')"></script>

    <script>
        let ghState = { sha: null, isConnected: false };

        window.onload = () => {
            Github.restaurarCredenciais();
            
            // Tenta usar o banco local se carregou
            if (window.NBV_DB) {
                preencherCamposSeguro(window.NBV_DB);
                Github.updateStatus(true); // Marca como pronto (local)
                document.getElementById('status-display').innerHTML = '<i class="fas fa-hdd"></i> Modo Local';
            } 
            // Se n√£o, tenta conectar GitHub
            else if(document.getElementById('ghToken').value) {
                Github.carregar(false);
            } else {
                showTab('tab-github');
            }
        };

        function showTab(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            const btns = document.querySelectorAll('.nav-btn');
            for(let b of btns) { if(b.getAttribute('onclick').includes(id)) b.classList.add('active'); }
        }

        const Github = {
            restaurarCredenciais: function() {
                ['ghToken','ghUser','ghRepo','ghPath'].forEach(k => {
                    if(localStorage.getItem(k)) document.getElementById(k).value = localStorage.getItem(k);
                });
            },
            
            salvarCredenciais: function() {
                ['ghToken','ghUser','ghRepo','ghPath'].forEach(k => {
                    localStorage.setItem(k, document.getElementById(k).value);
                });
            },

            getApiUrl: function() {
                const u = document.getElementById('ghUser').value;
                const r = document.getElementById('ghRepo').value;
                const p = document.getElementById('ghPath').value || 'js/database.js';
                return `https://api.github.com/repos/${u}/${r}/contents/${p}`;
            },

            setLoading: function(active, text) {
                document.getElementById('loading-overlay').style.display = active ? 'flex' : 'none';
                if(text) document.getElementById('loading-text').innerText = text;
            },

            updateStatus: function(connected) {
                const el = document.getElementById('status-display');
                const btn = document.getElementById('btn-gerar');
                ghState.isConnected = connected;
                
                if(connected) {
                    el.className = 'status-bar status-connected';
                    el.innerHTML = '<i class="fas fa-check-circle"></i> Conectado';
                    btn.disabled = false;
                    btn.style.opacity = 1;
                    btn.style.cursor = 'pointer';
                } else {
                    el.className = 'status-bar status-disconnected';
                    el.innerHTML = '<i class="fas fa-plug"></i> Desconectado';
                    btn.disabled = true;
                    btn.style.opacity = 0.5;
                }
            },

            carregar: async function(showAlert = true) {
                this.salvarCredenciais();
                const token = document.getElementById('ghToken').value;
                if(!token) { if(showAlert) alert("Preencha o Token!"); return; }

                this.setLoading(true, "Baixando dados...");

                try {
                    const res = await fetch(this.getApiUrl(), {
                        headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
                    });

                    if(!res.ok) {
                        if(res.status === 404) throw new Error("Arquivo n√£o encontrado. Verifique o caminho (ex: js/database.js)");
                        else throw new Error(res.statusText);
                    }

                    const data = await res.json();
                    ghState.sha = data.sha;
                    
                    const content = decodeURIComponent(escape(window.atob(data.content)));
                    let jsonStr = content.trim();
                    jsonStr = jsonStr.replace(/^window\.NBV_DB\s*=\s*/, '').replace(/;\s*$/, '').replace(/,(\s*[}\]])/g, '$1');

                    let db;
                    try { db = new Function('return ' + jsonStr)(); } 
                    catch(e) { throw new Error("Erro de sintaxe no arquivo do GitHub."); }

                    preencherCamposSeguro(db);
                    this.updateStatus(true);
                    if(showAlert) alert("Dados carregados com sucesso!");

                } catch(e) {
                    console.error(e);
                    this.updateStatus(false);
                    if(showAlert) alert("Erro: " + e.message);
                } finally {
                    this.setLoading(false);
                }
            },

            salvar: async function() {
                if(!ghState.isConnected) { alert("Conecte-se primeiro!"); return; }
                const token = document.getElementById('ghToken').value;
                
                this.setLoading(true, "Salvando na nuvem...");

                try {
                    const checkRes = await fetch(this.getApiUrl(), { headers: { 'Authorization': `token ${token}` } });
                    if(checkRes.ok) {
                        const checkData = await checkRes.json();
                        ghState.sha = checkData.sha;
                    }

                    const newDB = montarObjeto();
                    const contentStr = `window.NBV_DB = ${JSON.stringify(newDB, null, 4)};`;
                    const contentBase64 = window.btoa(unescape(encodeURIComponent(contentStr)));

                    const res = await fetch(this.getApiUrl(), {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: "Update via Admin", content: contentBase64, sha: ghState.sha })
                    });

                    if(!res.ok) throw new Error(await res.text());
                    
                    const resData = await res.json();
                    ghState.sha = resData.content.sha;
                    alert("‚úÖ Salvo no GitHub!");

                } catch(e) {
                    alert("Erro ao salvar: " + e.message);
                } finally {
                    this.setLoading(false);
                }
            }
        };

        // --- FUN√á√ÉO BLINDADA PARA PREENCHER CAMPOS ---
        function preencherCamposSeguro(db) {
            // Garante que o objeto tenha todas as chaves para n√£o dar erro de "undefined"
            const defaults = {
                financeiro: { markup:2.5, custoFixoDiagramacao:100, whatsapp:"", descontoPix:5, parcelasSemJuros:4, tabelaJuros:[] },
                logistica: { taxaEnvio:30, enderecoSede:"", cidadesGratis:[] },
                assets: { watermarkText:"NBV" },
                apresentacao: { book:{}, print:{}, digital:{} },
                tabelaFotolivros: [],
                produtosAvulsos: []
            };

            // Mescla superficialmente para garantir exist√™ncia
            const safeDB = { ...defaults, ...db };
            if(!safeDB.financeiro) safeDB.financeiro = defaults.financeiro;
            if(!safeDB.logistica) safeDB.logistica = defaults.logistica;
            if(!safeDB.apresentacao) safeDB.apresentacao = defaults.apresentacao;

            // Preenche UI
            document.getElementById('markup').value = safeDB.financeiro.markup || 2.5;
            document.getElementById('custoFixo').value = safeDB.financeiro.custoFixoDiagramacao || 0;
            document.getElementById('whatsNum').value = safeDB.financeiro.whatsapp || "";
            
            document.getElementById('shipPrice').value = safeDB.logistica.taxaEnvio || 0;
            document.getElementById('endSede').value = safeDB.logistica.enderecoSede || "";
            document.getElementById('freeCities').value = (safeDB.logistica.cidadesGratis || []).join(', ');
            
            document.getElementById('wmText').value = safeDB.assets?.watermarkText || "";

            if(safeDB.apresentacao) {
                document.getElementById('txtBook').value = safeDB.apresentacao.book?.text || "";
                document.getElementById('imgBook').value = safeDB.apresentacao.book?.img || "";
                document.getElementById('txtPrint').value = safeDB.apresentacao.print?.text || "";
                document.getElementById('imgPrint').value = safeDB.apresentacao.print?.img || "";
            }
            
            document.getElementById('fotolivro-table').innerHTML = ''; 
            (safeDB.tabelaFotolivros || []).forEach(i => addBookRow(i));

            document.getElementById('produtos-list').innerHTML = ''; 
            (safeDB.produtosAvulsos || []).forEach(i => addProdRow(i));
        }

        function montarObjeto() {
            const db = {
                assets: { watermarkText: document.getElementById('wmText').value, opacity: 0.2 },
                fluxo: { pedirEdicao: true, pedirAprovacao: true, minimoFotosLivro: 20 },
                financeiro: {
                    markup: Number(document.getElementById('markup').value),
                    custoFixoDiagramacao: Number(document.getElementById('custoFixo').value),
                    whatsapp: document.getElementById('whatsNum').value,
                    descontoPix: 5,
                    parcelasSemJuros: 4,
                    tabelaJuros: [0, 4.59, 5.99, 7.49, 8.99, 10.49, 11.99, 13.49, 14.99, 16.49, 17.99, 21.00]
                },
                logistica: {
                    taxaEnvio: Number(document.getElementById('shipPrice').value),
                    cidadesGratis: document.getElementById('freeCities').value.split(',').map(s=>s.trim()),
                    enderecoSede: document.getElementById('endSede').value
                },
                apresentacao: {
                    book: { text: document.getElementById('txtBook').value, img: document.getElementById('imgBook').value },
                    print: { text: document.getElementById('txtPrint').value, img: document.getElementById('imgPrint').value },
                    digital: { text: "Link Download", img: "https://via.placeholder.com/400x200" }
                },
                tabelaFotolivros: [],
                produtosAvulsos: [],
                regrasDiagramacao: { "15x20":3, "20x30":4, "30x40":5 }
            };

            document.querySelectorAll('.book-row').forEach(r => {
                db.tabelaFotolivros.push({
                    size: r.querySelector('.bk-size').value,
                    pages: Number(r.querySelector('.bk-pages').value),
                    price: Number(r.querySelector('.bk-price').value),
                    priceBox: Number(r.querySelector('.bk-box').value)
                });
            });

            document.querySelectorAll('.prod-row').forEach(r => {
                db.produtosAvulsos.push({
                    nome: r.querySelector('.pd-name').value,
                    preco: Number(r.querySelector('.pd-price').value),
                    icone: "fas fa-image"
                });
            });
            return db;
        }

        function addBookRow(d={}) {
            document.getElementById('fotolivro-table').insertAdjacentHTML('beforeend', 
            `<div class="list-item book-row">
                <input type="text" class="bk-size" value="${d.size||'20x30'}" style="width:70px">
                <input type="number" class="bk-pages" value="${d.pages||20}" style="width:50px">
                <input type="number" class="bk-price" value="${d.price||0}" style="width:70px" placeholder="Base">
                <input type="number" class="bk-box" value="${d.priceBox||0}" style="width:70px" placeholder="Box">
                <button class="btn-remove" onclick="this.parentElement.remove()">X</button>
            </div>`);
        }
        function addProdRow(d={}) {
            document.getElementById('produtos-list').insertAdjacentHTML('beforeend', 
            `<div class="list-item prod-row">
                <input type="text" class="pd-name" value="${d.nome||''}" style="flex:2">
                <input type="number" class="pd-price" value="${d.preco||0}" style="flex:1">
                <button class="btn-remove" onclick="this.parentElement.remove()">X</button>
            </div>`);
        }
        function addCreditoRow() {
            let opts = '<option value="">Selecione...</option>';
            document.querySelectorAll('.prod-row').forEach(r => { 
                const val = r.querySelector('.pd-name').value; 
                if(val) opts += `<option value="${val}">${val}</option>`; 
            });
            document.getElementById('creditos-list').insertAdjacentHTML('beforeend', 
            `<div class="list-item credito-row">
                <select class="cr-item" style="flex:2">${opts}</select>
                <input type="number" class="cr-qtd" value="1" style="width:70px">
                <button class="btn-remove" onclick="this.parentElement.remove()">X</button>
            </div>`);
        }

        async function gerarSiteCompleto() {
            if(!ghState.isConnected) return alert("Conecte ao GitHub!");
            const nomeCli = document.getElementById('cliName').value || "Cliente";
            const fotos = document.getElementById('cliFotos').value.split('\n').filter(x => x.trim());
            
            if(fotos.length === 0) return alert("Adicione fotos!");

            const creditos = [];
            document.querySelectorAll('.credito-row').forEach(r => {
                const item = r.querySelector('.cr-item').value;
                const qtd = Number(r.querySelector('.cr-qtd').value);
                if(item && qtd > 0) creditos.push({ item, qtd });
            });

            const configDB = montarObjeto();
            const configCliente = {
                ...configDB,
                cliente: { 
                    nome: nomeCli, 
                    entrada: Number(document.getElementById('cliEntrada').value),
                    incluirAlbum: document.getElementById('cliIncluirAlbum').value === 'sim',
                    creditos: creditos
                },
                fluxo: { 
                    pedirEdicao: document.getElementById('fluxoModo').value === 'venda', 
                    minimoFotosLivro: 15 
                },
                fotos: fotos
            };

            try {
                const response = await fetch('modelo_cliente.html');
                if (!response.ok) throw new Error("Erro ao ler modelo_cliente.html. Use Live Server.");
                let template = await response.text();

                const scriptInjection = `window.NBV_CONFIG = ${JSON.stringify(configCliente, null, 4)};`;
                template = template.replace('// [[INJECT_CONFIG_HERE]]', scriptInjection);

                const zip = new JSZip();
                zip.file("index.html", template);
                zip.generateAsync({type:"blob"}).then(function(content) {
                    saveAs(content, `Pedido_${nomeCli.replace(/\s+/g,'_')}.zip`);
                });

            } catch (e) {
                alert("ERRO: " + e.message);
            }
        }
    </script>
</body>
</html>
