<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Studio NBV - Admin V9</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="database.js"></script> <style>
        body { font-family: sans-serif; background: #f3f4f6; display: flex; height: 100vh; margin:0; }
        .sidebar { width: 250px; background: white; padding: 20px; border-right: 1px solid #ccc; display:flex; flex-direction:column; }
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        label { font-weight: bold; font-size: 0.9rem; display: block; margin-bottom: 5px; }
        .btn { width: 100%; padding: 12px; background: #0066cc; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top:5px }
        .btn:hover { background: #004c99; }
        .btn-green { background: #10b981; }
        .section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e5e7eb; }
        h2 { margin-top: 0; color: #1f2937; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>NBV Admin</h2>
    <label>GitHub Token (Repo: public_repo)</label>
    <input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxx">
    <label>Usuário GitHub</label>
    <input type="text" id="ghUser" placeholder="ex: warrior-photo">
    <label>Repositório</label>
    <input type="text" id="ghRepo" placeholder="ex: sistema-nbv">
    <button class="btn" onclick="salvarCredenciais()">Salvar Acesso</button>
    <hr>
    <small>Preencha os dados do cliente ao lado e clique em Publicar.</small>
</div>

<div class="main">
    <div class="section">
        <h2>1. Dados do Cliente</h2>
        <div style="display:flex; gap:10px">
            <div style="flex:1"><label>Nome do Cliente (Pasta)</label><input type="text" id="cliNome" placeholder="Ex: Casamento Maria"></div>
            <div style="flex:1"><label>Modo</label>
                <select id="fluxoModo">
                    <option value="venda">Venda Completa (Edição + Produtos)</option>
                    <option value="aprovacao">Aprovação Simples</option>
                </select>
            </div>
        </div>
        <label>Links das Fotos (Uma por linha)</label>
        <textarea id="cliFotos" rows="5" placeholder="https://..."></textarea>
    </div>

    <div class="section">
        <h2>2. Contrato & Financeiro</h2>
        <div style="display:flex; gap:10px">
            <div style="flex:1"><label>Entrada Já Paga (R$)</label><input type="number" id="cliEntrada" value="0"></div>
            <div style="flex:1">
                <label>Possui Contrato de Álbum?</label>
                <select id="temAlbum" onchange="toggleAlbum()">
                    <option value="nao">Não (Venda Avulsa)</option>
                    <option value="sim">Sim (Já incluso)</option>
                </select>
            </div>
        </div>
        <div id="area-contrato" style="display:none; background:#eff6ff; padding:10px; margin-top:10px; border-radius:4px">
            <div style="display:flex; gap:10px">
                <div style="flex:1"><label>Tamanho</label><select id="ctrTam"><option value="15x20">15x20</option><option value="20x30">20x30</option><option value="30x40">30x40</option></select></div>
                <div style="flex:1"><label>Qtd Fotos</label><input type="number" id="ctrQtd" value="20"></div>
                <div style="flex:1"><label>Valor Total Contrato</label><input type="number" id="ctrValor" value="0"></div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>3. Publicar</h2>
        <p>Isso criará uma página em: <code>https://[seu-user].github.io/[repo]/clientes/[nome-cliente]/</code></p>
        <button class="btn btn-green" onclick="publicarNoGithub()"><i class="fas fa-cloud-upload-alt"></i> GERAR E PUBLICAR SITE</button>
        <div id="status" style="margin-top:10px; font-weight:bold; color:#0066cc"></div>
    </div>
</div>

<script>
    // Carrega credenciais salvas
    window.onload = () => {
        ['ghToken', 'ghUser', 'ghRepo'].forEach(id => {
            if(localStorage.getItem(id)) document.getElementById(id).value = localStorage.getItem(id);
        });
    }

    function salvarCredenciais() {
        ['ghToken', 'ghUser', 'ghRepo'].forEach(id => localStorage.setItem(id, document.getElementById(id).value));
        alert("Salvo!");
    }

    function toggleAlbum() {
        document.getElementById('area-contrato').style.display = document.getElementById('temAlbum').value === 'sim' ? 'block' : 'none';
    }

    async function publicarNoGithub() {
        const status = document.getElementById('status');
        const token = document.getElementById('ghToken').value;
        const user = document.getElementById('ghUser').value;
        const repo = document.getElementById('ghRepo').value;
        const nome = document.getElementById('cliNome').value.trim();
        
        if(!token || !user || !repo || !nome) return alert("Preencha todos os campos (Token e Nome Cliente)");

        status.innerText = "⏳ Gerando configuração...";

        // 1. Monta o Objeto de Configuração
        const config = {
            ...window.NBV_DB, // Herda do database.js
            cliente: {
                nome: nome,
                entrada: parseFloat(document.getElementById('cliEntrada').value) || 0,
                incluirAlbum: document.getElementById('temAlbum').value === 'sim',
                contrato: {
                    tamanho: document.getElementById('ctrTam').value,
                    qtdFotos: parseInt(document.getElementById('ctrQtd').value) || 20,
                    valorTotal: parseFloat(document.getElementById('ctrValor').value) || 0
                }
            },
            fotos: document.getElementById('cliFotos').value.split('\n').filter(l => l.trim().length > 0),
            fluxo: {
                ...window.NBV_DB.fluxo,
                pedirEdicao: document.getElementById('fluxoModo').value === 'venda'
            }
        };

        try {
            status.innerText = "⏳ Baixando template modelo.html...";
            
            // 2. Lê o arquivo modelo.html (assumindo que está na mesma pasta)
            const response = await fetch('modelo.html');
            if(!response.ok) throw new Error("Não foi possível ler o modelo.html");
            let htmlContent = await response.text();

            // 3. Injeta a Configuração no HTML
            const scriptConfig = `<script>window.NBV_CONFIG = ${JSON.stringify(config, null, 2)};<\/script>`;
            htmlContent = htmlContent.replace('', scriptConfig);

            // 4. Prepara o Upload para o GitHub
            const path = `clientes/${nome.replace(/\s+/g, '-').toLowerCase()}/index.html`;
            const apiUrl = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
            
            // Verifica se o arquivo já existe (para pegar o SHA e atualizar)
            let sha = null;
            try {
                const check = await fetch(apiUrl, { headers: { Authorization: `token ${token}` } });
                if(check.ok) {
                    const data = await check.json();
                    sha = data.sha;
                }
            } catch(e) {}

            status.innerText = "⏳ Enviando para o GitHub...";

            // Codifica em Base64 (UTF-8 safe)
            const contentBase64 = btoa(unescape(encodeURIComponent(htmlContent)));

            const body = {
                message: `Publicando site para ${nome}`,
                content: contentBase64,
                branch: "main" // ou master
            };
            if(sha) body.sha = sha;

            const upload = await fetch(apiUrl, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            if(!upload.ok) {
                const err = await upload.json();
                throw new Error(err.message);
            }

            status.innerHTML = `✅ SUCESSO! Link: <a href="https://${user}.github.io/${repo}/${path}" target="_blank">Abrir Site</a>`;

        } catch(error) {
            console.error(error);
            status.innerText = "❌ Erro: " + error.message;
        }
    }
</script>
</body>
</html>
