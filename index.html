<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>NBV Admin - Master V11</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="database.js"></script>
    <style>
        :root { --primary: #0066cc; --bg: #f3f4f6; --sidebar: #fff; --text: #1f2937; --border: #e5e7eb; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 280px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .nav-btn { width: 100%; text-align: left; padding: 12px; margin-bottom: 5px; cursor: pointer; border: none; background: none; color: #666; font-weight: 600; display: flex; align-items: center; gap: 10px; border-radius: 6px; }
        .nav-btn:hover, .nav-btn.active { background: #eff6ff; color: var(--primary); }
        .nav-btn.active { font-weight: 700; border-right: 3px solid var(--primary); }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.85rem; color:#555; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; transition:0.2s }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: #10b981; }
        .btn-dark { background: #1f2937; }
        .status-bar { padding:15px; border-radius:8px; margin-bottom:20px; font-weight:bold; display:none; }
        .status-success { background:#dcfce7; color:#166534; }
        .status-error { background:#fee2e2; color:#991b1b; }
        .status-loading { background:#e0f2fe; color:#075985; }
        .gh-config { background: #f1f5f9; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 20px; font-size: 0.85rem; }
        .gh-config input { padding: 6px; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2 style="margin:0 0 20px; color:#333"><i class="fas fa-camera"></i> Studio<span style="color:var(--primary)">NBV</span></h2>
        
        <div class="gh-config">
            <label><i class="fab fa-github"></i> GitHub</label>
            <input type="password" id="ghToken" placeholder="Token">
            <input type="text" id="ghUser" placeholder="Usuário">
            <input type="text" id="ghRepo" placeholder="Repositório">
            <input type="text" id="ghBranch" placeholder="Branch (main)" value="main">
            <button class="btn btn-dark" style="padding:5px; font-size:0.8rem" onclick="salvarCredenciaisLocal()">Salvar</button>
        </div>

        <nav>
            <button class="nav-btn active" onclick="showTab('tab-cliente')"><i class="fas fa-user-plus"></i> Novo Cliente</button>
            <button class="nav-btn" onclick="showTab('tab-textos')"><i class="fas fa-paragraph"></i> Textos & Modais</button>
            <button class="nav-btn" onclick="showTab('tab-config')"><i class="fas fa-cogs"></i> Configs Gerais</button>
        </nav>

        <div style="margin-top:auto">
            <button class="btn btn-primary" onclick="salvarDatabaseGlobal()"><i class="fas fa-cloud-upload-alt"></i> SALVAR DB GLOBAL</button>
        </div>
    </div>

    <div class="main-content">
        <div id="status-display" class="status-bar"></div>

        <div id="tab-cliente" class="section active">
            <h2>Gerar Link do Cliente</h2>
            <div style="background:white; padding:20px; border-radius:8px; border:1px solid #eee">
                <label>Nome do Cliente (Pasta)</label>
                <input type="text" id="cliNome" placeholder="Ex: Casamento_Ana">
                <label>Links das Fotos</label>
                <textarea id="cliFotos" rows="6"></textarea>
                <button class="btn btn-success" onclick="publicarCliente()">GERAR E PUBLICAR SITE</button>
            </div>
        </div>

        <div id="tab-textos" class="section">
            <h2>Textos de Venda (Modais)</h2>
            <div style="background:white; padding:20px; border-radius:8px; border:1px solid #eee">
                <h3>Fotolivro</h3>
                <input type="text" id="txtBookTitle" placeholder="Título">
                <textarea id="txtBookDesc" rows="3" placeholder="Descrição"></textarea>
                <h3>Revelação</h3>
                <input type="text" id="txtPrintTitle" placeholder="Título">
                <textarea id="txtPrintDesc" rows="3" placeholder="Descrição"></textarea>
                <h3>Digital</h3>
                <input type="text" id="txtDigTitle" placeholder="Título">
                <textarea id="txtDigDesc" rows="3" placeholder="Descrição"></textarea>
            </div>
        </div>

        <div id="tab-config" class="section">
            <h2>Configurações Gerais</h2>
            <div style="background:white; padding:20px; border-radius:8px; border:1px solid #eee">
                <label>Marca D'água Texto</label><input type="text" id="confWmText">
                <label>Marca D'água Opacidade</label><input type="number" id="confWmOp" step="0.1">
                <label>WhatsApp</label><input type="text" id="confWhats">
            </div>
        </div>
    </div>

<script>
    window.onload = function() {
        carregarCredenciaisLocal();
        if(window.NBV_DB) carregarDados(window.NBV_DB);
    };

    function showTab(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    function showStatus(msg, type='loading') {
        const el = document.getElementById('status-display');
        el.className = 'status-bar status-' + type;
        el.innerHTML = msg;
        el.style.display = 'block';
    }

    function carregarDados(db) {
        // Textos
        const apr = db.apresentacao || {};
        if(apr.fotolivro) { document.getElementById('txtBookTitle').value = apr.fotolivro.titulo; document.getElementById('txtBookDesc').value = apr.fotolivro.texto; }
        if(apr.revelacao) { document.getElementById('txtPrintTitle').value = apr.revelacao.titulo; document.getElementById('txtPrintDesc').value = apr.revelacao.texto; }
        if(apr.digital) { document.getElementById('txtDigTitle').value = apr.digital.titulo; document.getElementById('txtDigDesc').value = apr.digital.texto; }
        
        // Configs
        document.getElementById('confWmText').value = db.assets.watermarkText;
        document.getElementById('confWmOp').value = db.assets.opacity;
        document.getElementById('confWhats').value = db.financeiro.whatsapp;
    }

    function montarObjeto() {
        // Recria objeto baseado no window.NBV_DB atual + inputs
        const db = window.NBV_DB; 
        db.assets.watermarkText = document.getElementById('confWmText').value;
        db.assets.opacity = parseFloat(document.getElementById('confWmOp').value);
        db.financeiro.whatsapp = document.getElementById('confWhats').value;

        db.apresentacao = {
            fotolivro: { titulo: document.getElementById('txtBookTitle').value, texto: document.getElementById('txtBookDesc').value, img: "https://via.placeholder.com/600x400" },
            revelacao: { titulo: document.getElementById('txtPrintTitle').value, texto: document.getElementById('txtPrintDesc').value, img: "https://via.placeholder.com/600x400" },
            digital: { titulo: document.getElementById('txtDigTitle').value, texto: document.getElementById('txtDigDesc').value, img: "https://via.placeholder.com/600x400" }
        };
        return db;
    }

    // GITHUB
    function getGh() {
        return {
            token: document.getElementById('ghToken').value,
            user: document.getElementById('ghUser').value,
            repo: document.getElementById('ghRepo').value,
            branch: document.getElementById('ghBranch').value
        };
    }
    function salvarCredenciaisLocal() {
        const c = getGh();
        localStorage.setItem('nbv_gh_token', c.token); localStorage.setItem('nbv_gh_user', c.user);
        localStorage.setItem('nbv_gh_repo', c.repo); localStorage.setItem('nbv_gh_branch', c.branch);
        alert("Salvo!");
    }
    function carregarCredenciaisLocal() {
        if(localStorage.getItem('nbv_gh_token')) document.getElementById('ghToken').value = localStorage.getItem('nbv_gh_token');
        if(localStorage.getItem('nbv_gh_user')) document.getElementById('ghUser').value = localStorage.getItem('nbv_gh_user');
        if(localStorage.getItem('nbv_gh_repo')) document.getElementById('ghRepo').value = localStorage.getItem('nbv_gh_repo');
        if(localStorage.getItem('nbv_gh_branch')) document.getElementById('ghBranch').value = localStorage.getItem('nbv_gh_branch');
    }

    async function upload(creds, path, content, msg) {
        const url = `https://api.github.com/repos/${creds.user}/${creds.repo}/contents/${path}`;
        let sha = null;
        try { const r = await fetch(url+`?ref=${creds.branch}`,{headers:{Authorization:`token ${creds.token}`}}); if(r.ok) sha = (await r.json()).sha; } catch(e){}
        
        const res = await fetch(url, {
            method: 'PUT',
            headers: { Authorization:`token ${creds.token}`, 'Content-Type':'application/json' },
            body: JSON.stringify({ message: msg, content: btoa(unescape(encodeURIComponent(content))), branch: creds.branch, sha: sha })
        });
        if(!res.ok) throw new Error((await res.json()).message);
        return `https://${creds.user}.github.io/${creds.repo}/${path}`;
    }

    async function salvarDatabaseGlobal() {
        const creds = getGh();
        if(!creds.token) return alert("Configure GitHub");
        showStatus("Salvando...", "loading");
        try {
            const db = montarObjeto();
            await upload(creds, 'database.js', `window.NBV_DB = ${JSON.stringify(db, null, 4)};`, "Update DB");
            window.NBV_DB = db;
            showStatus("Salvo com sucesso!", "success");
        } catch(e) { showStatus("Erro: "+e.message, "error"); }
    }

    async function publicarCliente() {
        const creds = getGh();
        const nome = document.getElementById('cliNome').value.trim();
        if(!creds.token || !nome) return alert("Preencha dados");
        showStatus("Gerando...", "loading");
        
        try {
            const db = montarObjeto();
            const config = { ...db, cliente: { nome: nome }, fotos: document.getElementById('cliFotos').value.split('\n').filter(s=>s.length>5) };
            
            const req = await fetch('modelo.html');
            let html = await req.text();
            html = html.replace('', `<script>window.NBV_CONFIG = ${JSON.stringify(config, null, 2)};<\/script>`);
            
            const url = await upload(creds, `clientes/${nome}/index.html`, html, `Site: ${nome}`);
            showStatus(`Sucesso! <a href="${url}" target="_blank">${url}</a>`, "success");
        } catch(e) { showStatus("Erro: "+e.message, "error"); }
    }
</script>
</body>
</html>
